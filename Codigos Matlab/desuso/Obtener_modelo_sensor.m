clc;
clear;
close all;

% === Configuración del experimento ===
T_muestreo = 0.01; % [s]
duracion_total = 10; % [s]
cantidad_muestras = duracion_total / T_muestreo;

% === Pegar los datos copiados de Serial Monitor aquí ===
% (cada dato en una nueva línea, como vector columna)
datos = [
0.49,0.98,1.38,1.74,2.09,2.46,2.80,3.15,3.46,3.76,4.02,4.24,4.53,4.80,5.02,5.23,5.44,5.62,5.75,5.90,6.08,6.28,6.49,6.67,6.83,6.96,7.04,7.10,7.17,7.25,7.35,7.47,7.62,7.76,7.87,7.93,7.89,7.88,7.88,7.97,8.09,8.25,8.39,8.46,8.42,8.34,8.29,8.28,8.34,8.45,8.54,8.62,8.67,8.67,8.69,8.72,8.76,8.78,8.78,8.78,8.79,8.79,8.82,8.87,8.91,8.95,8.98,8.96,8.96,8.94,8.92,8.91,8.93,8.99,9.05,9.06,9.04,8.98,8.93,8.93,8.97,9.06,9.13,9.18,9.18,9.13,9.07,9.01,9.00,9.07,9.17,9.22,9.23,9.24,9.18,9.11,9.09,9.10,9.15,9.17,9.21,9.25,9.21,9.19,9.19,9.17,9.18,9.20,9.25,9.27,9.23,9.17,9.15,9.14,9.15,9.19,9.24,9.24,9.20,9.17,9.13,9.12,9.12,9.17,9.21,9.22,9.25,9.27,9.25,9.22,9.21,9.21,9.22,9.21,9.20,9.17,9.13,9.13,9.13,9.15,9.19,9.22,9.22,9.21,9.20,9.22,9.26,9.24,9.24,9.20,9.17,9.12,9.13,9.17,9.21,9.21,9.20,9.16,9.12,9.06,9.09,9.11,9.15,9.18,9.23,9.25,9.21,9.14,9.10,9.02,9.06,9.16,9.22,9.18,9.17,9.17,9.16,9.07,9.03,9.07,9.22,9.31,9.28,9.16,9.13,9.11,9.01,9.03,9.18,9.30,9.29,9.36,9.41,9.33,9.18,9.04,9.05,9.02,9.01,9.11,9.16,9.28,9.33,9.36,9.33,9.14,9.04,9.02,9.08,9.11,9.14,9.21,9.27,9.23,9.20,9.19,9.14,9.06,8.94,8.92,8.90,8.90,9.04,9.12,9.26,9.31,9.27,9.14,9.04,9.03,8.99,8.98,9.05,9.16,9.29,9.34,9.27,9.14,9.07,9.03,8.96,8.87,8.86,8.99,9.15,9.26,9.30,9.30,9.28,9.19,9.03,8.95,8.93,8.99,9.09,9.26,9.41,9.42,9.34,9.04,8.83,8.75,8.69,8.74,8.85,9.12,9.35,9.68,9.65,9.22,9.04,8.91,8.72,8.61,8.59,8.80,9.07,9.37,9.56,9.63,9.41,9.09,8.79,8.61,8.63,8.69,8.96,9.32,9.42,9.41,9.19,9.20,8.96,8.78,8.66,8.77,8.99,9.09,9.22,9.33,9.38,9.41,9.34,9.27,9.16,9.06,9.60,9.81,9.56,9.33,9.16,9.12,8.85,8.36,8.18,8.32,7.94,7.54,7.25,6.81,6.11,5.29,4.53,3.93,3.44,3.03,2.73,2.31,1.83,1.13,0.32,-0.77,-1.89,-3.09,-4.25,-5.18,-1.53,-5.03,-1.99,-1.66,-1.15,0.33,-0.54,-0.32,-3.13,-1.57,-5.41,-6.19,-6.36,-8.57,-8.03,-10.47,-12.75,-13.54,-13.08,-13.52,-14.30,-15.37,-15.06,-15.18,-15.71,-16.67,-16.32,-16.59,-17.07,-17.66,-18.09,-18.30,-18.73,-19.10,-19.44,-19.87,-20.16,-20.35,-20.57,-20.93,-21.19,-21.24,-21.35,-21.61,-21.66,-21.60,-21.43,-21.44,-21.46,-21.56,-21.76,-22.07,-22.32,-22.46,-22.52,-22.56,-22.56,-22.56,-22.60,-22.60,-22.63,-22.62,-22.63,-22.71,-22.85,-22.96,-23.00,-22.97,-22.91,-22.94,-22.96,-23.05,-23.17,-23.24,-23.19,-23.17,-23.09,-23.00,-23.03,-23.24,-23.40,-23.47,-23.42,-23.40,-23.38,-23.39,-23.35,-23.37,-23.42,-23.48,-23.52,-23.43,-23.30,-23.30,-23.38,-23.42,-23.46,-23.54,-23.62,-23.71,-23.77,-23.79,-23.82,-23.87,-23.79,-23.70,-23.55,-23.54,-23.32,-23.08,-23.14,-23.57,-24.07,-24.60,-24.71,-24.61,-24.61,-24.67,-24.65,-24.34,-24.25,-24.07,-23.90,-23.73,-23.72,-23.88,-23.94,-23.94,-23.90,-23.87,-23.87,-23.92,-23.93,-23.91,-23.88,-23.86,-23.88,-23.81,-23.81,-23.91,-23.97,-23.97,-23.96,-24.00,-24.05,-24.14,-24.10,-24.06,-23.97,-23.93,-23.87,-23.82,-23.77,-23.71,-23.67,-23.66,-23.68,-23.71,-23.77,-23.76,-23.76,-23.76,-23.75,-23.74,-23.72,-23.69,-23.64,-23.60,-23.60,-23.63,-23.66,-23.70,-23.72,-23.70,-23.68,-23.66,-23.62,-23.57,-23.53,-23.50,-23.50,-23.51,-23.53,-23.56,-23.58,-23.60,-23.57,-23.57,-23.56,-23.56,-23.57,-23.57,-23.57,-23.56,-23.55,-23.56,-23.55,-23.53,-23.54,-23.54,-23.58,-23.62,-23.64,-23.62,-23.61,-23.57,-23.53,-23.51,-23.51,-23.52,-23.53,-23.54,-23.55,-23.56,-23.55,-23.53,-23.50,-23.48,-23.48,-23.48,-23.50,-23.52,-23.54,-23.54,-23.56,-23.58,-23.59,-23.58,-23.56,-23.53,-23.52,-23.52,-23.56,-23.57,-23.60,-23.60,-23.60,-23.59,-23.58,-23.60,-23.59,-23.58,-23.58,-23.60,-23.61,-23.61,-23.60,-23.58,-23.56,-23.54,-23.56,-23.57,-23.61,-23.60,-23.59,-23.60,-23.61,-23.62,-23.61,-23.62,-23.63,-23.62,-23.61,-23.62,-23.60,-23.61,-23.62,-23.60,-23.58,-23.58,-23.57,-23.56,-23.53,-23.52,-23.51,-23.52,-23.55,-23.56,-23.55,-23.52,-23.51,-23.50,-23.52,-23.53,-23.56,-23.59,-23.61,-23.62,-23.62,-23.61,-23.61,-23.60,-23.60,-23.60,-23.61,-23.62,-23.63,-23.60,-23.58,-23.56,-23.55,-23.52,-23.50,-23.48,-23.49,-23.51,-23.53,-23.53,-23.53,-23.53,-23.52,-23.54,-23.56,-23.56,-23.56,-23.57,-23.60,-23.61,-23.63,-23.60,-23.57,-23.54,-23.55,-23.55,-23.57,-23.59,-23.59,-23.60,-23.60,-23.58,-23.57,-23.57,-23.57,-23.58,-23.59,-23.58,-23.56,-23.57,-23.57,-23.57,-23.55,-23.56,-23.54,-23.56,-23.56,-23.56,-23.57,-23.55,-23.54,-23.52,-23.51,-23.50,-23.47,-23.44,-23.45,-23.46,-23.49,-23.52,-23.53,-23.52,-23.50,-23.48,-23.46,-23.47,-23.48,-23.51,-23.54,-23.55,-23.59,-23.61,-23.60,-23.63,-23.61,-23.59,-23.58,-23.55,-23.51,-23.50,-23.47,-23.48,-23.48,-23.49,-23.52,-23.52,-23.53,-23.54,-23.52,-23.53,-23.53,-23.55,-23.57,-23.56,-23.57,-23.57,-23.56,-23.56,-23.57,-23.59,-23.60,-23.60,-23.59,-23.58,-23.56,-23.53,-23.52,-23.51,-23.49,-23.48,-23.45,-23.47,-23.49,-23.49,-23.49,-23.51,-23.50,-23.49,-23.48,-23.47,-23.48,-23.50,-23.52,-23.55,-23.58,-23.58,-23.57,-23.55,-23.54,-23.53,-23.51,-23.52,-23.52,-23.53,-23.53,-23.50,-23.51,-23.51,-23.53,-23.54,-23.53,-23.53,-23.53,-23.53,-23.51,-23.50,-23.50,-23.51,-23.52,-23.51,-23.53,-23.53,-23.53,-23.55,-23.55,-23.55,-23.55,-23.54,-23.53,-23.49,-23.47,-23.48,-23.48,-23.49,-23.51,-23.50,-23.50,-23.49,-23.49,-23.49,-23.49,-23.50,-23.50,-23.51,-23.51,-23.52,-23.52,-23.49,-23.50,-23.50,-23.52,-23.53,-23.54,-23.53,-23.54,-23.55,-23.55,-23.56,-23.57,-23.58,-23.58,-23.57,-23.55,-23.54,-23.55,-23.55,-23.54,-23.55,-23.55,-23.51,-23.51,-23.49,-23.48,-23.48,-23.49,-23.50,-23.52,-23.54,-23.53,-23.54,-23.54,-23.53,-23.54,-23.54,-23.53,-23.53,-23.53,-23.54,-23.54,-23.56,-23.56,-23.57,-23.57,-23.58,-23.56,-23.55,-23.55,-23.56,-23.57,-23.56,-23.56,-23.54,-23.53,-23.54,-23.54,-23.56,-23.56,-23.56,-23.59,-23.62,-23.63,-23.62,-23.61,-23.64,-23.63,-23.64,-23.64,-23.62,-23.61,-23.62,-23.59,-23.59,-23.59,-23.57,-23.58,-23.55,-23.53,-23.51,-23.49,-23.46,-23.44,-23.44,-23.45,-23.47,-23.47,-23.47,-23.48,-23.50,-23.53,-23.56,-23.57,-23.57,-23.57,-23.59,-23.59,-23.60,-23.59,-23.59,-23.60,-23.58,-23.54,-23.52,-23.52,-23.50,-23.52,-23.54,-23.54,-23.53,-23.51,-23.51,-23.49,-23.48,-23.48,-23.47,-23.47,-23.48,-23.49,-23.49,-23.49,-23.50,-23.50,-23.51,-23.52,-23.54,-23.53,-23.54,-23.55,-23.55,-23.55,-23.56,-23.56,-23.55,-23.54,-23.50,-23.48,-23.49,-23.49,-23.51,-23.50,-23.51,-23.51,-23.51,-23.51,-23.52,-23.53,-23.54,-23.57,-23.59,-23.57,-23.53,-23.51,-23.49,-23.48,-23.49,-23.50,-23.52,-23.51,-23.50,-23.50,-23.49,-23.48,-23.49,-23.50,-23.50,-23.51,-23.53,-23.53,-23.52,-23.51,-23.51,-23.53,-23.52,-23.52,-23.51,-23.52,-23.51,-23.53,-23.53,-23.54,-23.54,-23.55,-23.54,-23.55,-23.54,-23.52,-23.51,
];

% === Crear vector de tiempo ===
t = (0:(cantidad_muestras-1)) * T_muestreo;

% === Validar tamaño ===
if length(datos) ~= cantidad_muestras
    error('La cantidad de datos no coincide con la cantidad de muestras esperadas.');
end

% === Graficar datos ===
figure;
plot(t, datos, 'b', 'LineWidth', 1.5);
grid on;
xlabel('Tiempo [s]');
ylabel('Ángulo [grados]');
title('Seleccionar inicio y fin del cambio');
xlim([0 duracion_total]);

% === Agregar cursores verticales ===
hold on;
xline1 = xline(t(1), '--r', 'Inicio', 'LabelOrientation', 'horizontal', 'LabelVerticalAlignment', 'bottom');
xline2 = xline(t(end), '--g', 'Fin', 'LabelOrientation', 'horizontal', 'LabelVerticalAlignment', 'bottom');

% === Hacer cursores interactivos ===
dcm_obj = datacursormode(gcf);
datacursormode on;
disp('Seleccioná el primer punto (inicio del cambio).');
pause;
cursor_info = getCursorInfo(dcm_obj);
t_inicio = cursor_info.Position(1);

disp('Seleccioná el segundo punto (fin del cambio).');
pause;
cursor_info = getCursorInfo(dcm_obj);
t_fin = cursor_info.Position(1);

% === Encontrar índices correspondientes ===
[~, idx_inicio] = min(abs(t - t_inicio));
[~, idx_fin] = min(abs(t - t_fin));

% === Extraer datos seleccionados ===
t_recortado = t(idx_inicio:idx_fin);
datos_recortados = datos(idx_inicio:idx_fin);

% === Cálculo del 63% ===
y0 = datos_recortados(1);
yf = datos_recortados(end);
valor_63 = y0 + 0.632 * (yf - y0);

% === Buscar el tiempo donde se alcanza el 63% ===
[~, idx_tau] = min(abs(datos_recortados - valor_63));
t_tau = t_recortado(idx_tau);

% === Mostrar resultados ===
figure;
plot(t_recortado, datos_recortados, 'b', 'LineWidth', 1.5);
hold on;
plot(t_tau, datos_recortados(idx_tau), 'ro', 'MarkerSize', 8, 'MarkerFaceColor', 'r');
yline(valor_63, '--k', '63%');
xlabel('Tiempo [s]');
ylabel('Ángulo [grados]');
title(['Respuesta seleccionada - \tau encontrado en t = ', num2str(t_tau - t_recortado(1), '%.4f'), ' s']);
grid on;

% === Mostrar valor numérico de tau ===
tau = t_tau - t_recortado(1); % Tiempo desde el inicio hasta alcanzar el 63%
fprintf('\n==============================\n');
fprintf('Constante de tiempo estimada (tau): %.4f segundos\n', tau);
fprintf('==============================\n');
