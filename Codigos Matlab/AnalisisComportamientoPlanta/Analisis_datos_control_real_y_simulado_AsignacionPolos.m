clc;
close all;

% === Inicialización de celdas para almacenar los datos experimentales ===
tiempo = cell(1,1);
angulo = cell(1,1);
pwm    = cell(1,1);
error  = cell(1,1);
tiempo{1} = [0.366, 0.618, 0.902, 1.204, 1.520, 1.819, 2.117, 2.415, 2.714, 3.013, 3.314, 3.614, 3.912, 4.211, 4.510, 4.808, 5.121, 5.420, 5.719, 6.017, 6.316, 6.614, 6.913, 7.215, 7.514, 7.815, 8.115, 8.413, 8.727, 9.005, 9.304, 9.603, 9.903, 10.202, 10.521, 10.818, 11.115, 11.412, 11.709, 12.007, 12.323, 12.602, 12.902, 13.200, 13.519, 13.816, 14.113, 14.410, 14.707, 15.007, 15.304, 15.602, 15.913, 16.210, 16.506, 16.806, 17.104, 17.401, 17.720, 18.019, 18.316, 18.612, 18.909, 19.221, 19.519, 19.819, 20.115, 20.411, 20.707, 21.002, 21.320, 21.620, 21.920, 22.218, 22.529, 22.804, 23.104, 23.403, 23.700, 24.018, 24.315, 24.612, 24.909, 25.209, 25.512, 25.809, 26.119, 26.416, 26.713, 27.010, 27.306, 27.603, 27.900, 28.220, 28.517, 28.814, 29.111, 29.421, 29.718, 30.015, 30.312, 30.613, 30.910, 31.207, 31.504, 31.802, 32.102, 32.420, 32.730, 33.006, 33.303, 33.603, 33.900, 34.218, 34.515, 34.812, 35.109, 35.405, 35.702, 36.000, 36.312, 36.613, 36.910, 37.207, 37.505, 37.802, 38.121, 38.418, 38.715, 39.012, 39.310, 39.620, 39.919, 40.217, 40.520, 40.817, 41.115, 41.412, 41.709, 42.006, 42.303, 42.601, 42.932, 43.208, 43.505, 43.802, 44.120, 44.418, 44.715, 45.012, 45.309, 45.610, 45.909, 46.209, 46.523, 46.820, 47.117, 47.417, 47.716, 48.015, 48.312, 48.609, 48.905, 49.201, 49.521, 49.832, 50.107, 50.404, 50.704, 51.004, 51.302, 51.605, 51.906, 52.205, 52.504, 52.802, 53.120, 53.432, 53.706, 54.004, 54.301, 54.619, 54.916, 55.213, 55.510, 55.808, 56.104, 56.401, 56.734, 57.008, 57.305, 57.602, 57.900, 58.219, 58.516, 58.813, 59.110, 59.407, 59.705];
angulo{1} = [-3.90, -1.80, -1.65, -1.65, -1.65, -1.65, -1.65, -1.65, -1.65, -1.65, -1.50, -1.50, -1.50, -1.50, -1.50, -1.50, -1.50, -1.50, -1.50, -1.50, -1.50, -1.50, -1.50, -1.35, -1.35, -1.20, -1.20, -1.20, -1.20, -1.05, -1.05, -1.05, -0.90, -0.90, -0.90, -0.90, -0.90, -0.90, -0.90, -0.90, -0.90, -0.75, -0.90, -0.75, -0.75, -0.75, -0.75, -0.75, -0.75, -0.60, -0.60, -0.60, -0.60, -0.60, -0.60, -0.45, -0.45, -0.45, -0.45, -0.30, -0.30, -0.30, -0.30, -0.30, -0.15, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.15, 0.30, 0.30, 0.30, 0.30, 0.45, 0.60, 0.60, 0.60, 0.60, 0.60, 0.60, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.90, 0.75, 0.75, 0.75, 0.75, 0.75, 0.90, 0.90, 0.90, 0.90, 0.90, 0.90, 0.90, 0.90, 0.90, 1.05, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.35, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.05, 1.20, 1.20, 1.20, 1.20, 1.05, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.20, 1.05, 1.20, 1.20, 1.20, 1.20, 1.20, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05];
pwm{1} = [1360.4, 1320.0, 1322.1, 1320.8, 1322.0, 1322.4, 1322.6, 1322.8, 1323.1, 1323.3, 1322.8, 1323.6, 1323.8, 1324.1, 1324.3, 1324.5, 1324.7, 1324.9, 1325.1, 1325.4, 1325.6, 1325.8, 1326.0, 1325.1, 1326.2, 1325.6, 1326.4, 1326.7, 1326.9, 1326.7, 1327.0, 1327.2, 1325.8, 1327.2, 1327.4, 1327.6, 1327.7, 1327.8, 1328.0, 1328.1, 1328.9, 1327.7, 1329.0, 1328.3, 1328.5, 1328.7, 1328.8, 1328.9, 1329.0, 1327.5, 1328.9, 1329.1, 1329.2, 1329.3, 1329.4, 1328.4, 1329.3, 1329.5, 1329.6, 1329.3, 1329.5, 1329.6, 1329.6, 1329.7, 1329.2, 1329.0, 1329.4, 1329.4, 1329.5, 1329.5, 1329.5, 1329.1, 1328.6, 1329.1, 1329.1, 1329.0, 1328.6, 1328.4, 1328.5, 1328.5, 1328.4, 1328.3, 1328.2, 1327.8, 1327.3, 1327.7, 1327.7, 1327.6, 1327.5, 1327.4, 1327.3, 1327.2, 1327.1, 1327.0, 1326.9, 1326.8, 1326.7, 1326.6, 1326.5, 1326.4, 1326.3, 1326.8, 1326.1, 1326.0, 1325.8, 1324.4, 1325.7, 1325.5, 1325.4, 1325.3, 1325.2, 1324.7, 1324.8, 1324.7, 1324.5, 1324.4, 1324.3, 1324.2, 1324.1, 1323.9, 1323.3, 1323.1, 1323.2, 1323.0, 1322.9, 1322.7, 1322.5, 1322.4, 1322.2, 1322.0, 1321.9, 1321.7, 1321.0, 1321.5, 1321.4, 1321.0, 1320.8, 1320.7, 1320.5, 1320.3, 1320.1, 1320.0, 1319.8, 1319.6, 1319.5, 1319.3, 1319.1, 1318.9, 1318.7, 1318.6, 1318.4, 1318.1, 1317.8, 1318.3, 1317.6, 1317.6, 1317.4, 1316.9, 1318.6, 1316.9, 1316.7, 1316.6, 1316.4, 1316.2, 1316.1, 1315.9, 1315.8, 1315.6, 1316.2, 1313.9, 1315.0, 1314.2, 1314.1, 1313.8, 1315.1, 1314.5, 1314.3, 1314.2, 1314.0, 1313.9, 1313.7, 1313.5, 1313.4, 1313.2, 1313.1, 1312.9, 1312.8, 1312.6, 1312.5, 1312.3, 1312.2, 1312.0, 1311.9, 1311.7, 1311.5, 1311.4, 1311.2, 1311.1, 1310.9];
error{1} = [3.90, 1.80, 1.65, 1.65, 1.65, 1.65, 1.65, 1.65, 1.65, 1.65, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.35, 1.35, 1.20, 1.20, 1.20, 1.20, 1.05, 1.05, 1.05, 0.90, 0.90, 0.90, 0.90, 0.90, 0.90, 0.90, 0.90, 0.90, 0.75, 0.90, 0.75, 0.75, 0.75, 0.75, 0.75, 0.75, 0.60, 0.60, 0.60, 0.60, 0.60, 0.60, 0.45, 0.45, 0.45, 0.45, 0.30, 0.30, 0.30, 0.30, 0.30, 0.15, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, -0.15, -0.30, -0.30, -0.30, -0.30, -0.45, -0.60, -0.60, -0.60, -0.60, -0.60, -0.60, -0.75, -0.75, -0.75, -0.75, -0.75, -0.75, -0.75, -0.75, -0.75, -0.75, -0.75, -0.75, -0.75, -0.75, -0.75, -0.75, -0.75, -0.75, -0.75, -0.75, -0.75, -0.75, -0.90, -0.75, -0.75, -0.75, -0.75, -0.75, -0.90, -0.90, -0.90, -0.90, -0.90, -0.90, -0.90, -0.90, -0.90, -1.05, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.35, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.05, -1.20, -1.20, -1.20, -1.20, -1.05, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.20, -1.05, -1.20, -1.20, -1.20, -1.20, -1.20, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05, -1.05];
%% 



% === Parámetro de recorte en segundos ===
recorte_inicio = 2.3;  % segundos a recortar desde el inicio

% === Número de experimentos reales definidos ===
n_experimentos = numel(tiempo);

% === Recortar y desplazar tiempo en cada experimento ===
for i = 1:n_experimentos
    indices_validos = tiempo{i} >= recorte_inicio;

    tiempo{i} = tiempo{i}(indices_validos) - recorte_inicio;
    angulo{i} = angulo{i}(indices_validos);
    pwm{i}    = pwm{i}(indices_validos);
    error{i}  = error{i}(indices_validos);
end

% === BLOQUE COMENTADO: Cargar y procesar datos de simulación ===
% s = load('datos_simulacion_control.mat');
% ts = struct2cell(s); ts = ts{1};
% 
% tiempo_sim = ts.Time;
% datos_sim = ts.Data;
% 
% angulo_sim = datos_sim(:, 1);  % columna 1 = ángulo
% pwm_sim    = datos_sim(:, 2);  % columna 2 = PWM
% error_sim  = datos_sim(:, 3);  % columna 3 = error
% 
% % Redondear para visualización
% tiempo_sim = round(tiempo_sim, 2);
% angulo_sim = round(angulo_sim, 2);

% === Si los datos no están en celdas, convertirlos ===
if ~iscell(tiempo)
    tiempo = {tiempo};
    angulo = {angulo};
    error  = {error};
    pwm    = {pwm};
    n_experimentos = 1;
end

% === Graficar ÁNGULO solo de experimentos ===
figure('Name','Respuesta experimental: Ángulo','Units','normalized','Position',[0.1 0.4 0.8 0.45]);
hold on; grid on;

colores = lines(n_experimentos);
for i = 1:n_experimentos
    plot(tiempo{i}, angulo{i}, '-', 'Color', colores(i,:), 'LineWidth', 1.5);
end

xlabel('Tiempo (s)');
ylabel('Ángulo (°)');
title('Respuesta experimental del ángulo');
legend_labels = cell(1, n_experimentos);
for i = 1:n_experimentos
    legend_labels{i} = sprintf('Experimento %d', i);
end

legend(legend_labels, 'Location', 'best');

% === Graficar PWM y Error solo de experimentos ===
figure('Name','PWM y Error: Experimentos','Units','normalized','Position',[0.1 0.05 0.8 0.35]);

subplot(1,2,1); hold on; grid on;
title('PWM aplicado'); xlabel('Tiempo (s)'); ylabel('PWM [\mus]');
for i = 1:n_experimentos
    plot(tiempo{i}, pwm{i}, '-', 'Color', colores(i,:), 'LineWidth', 1.3, 'DisplayName', sprintf('Experimento %d', i));
end
legend('Location', 'best');

subplot(1,2,2); hold on; grid on;
title('Error de control'); xlabel('Tiempo (s)'); ylabel('Error (rad)');
for i = 1:n_experimentos
    plot(tiempo{i}, error{i}, '-', 'Color', colores(i,:), 'LineWidth', 1.3, 'DisplayName', sprintf('Experimento %d', i));
end
legend('Location', 'best');
